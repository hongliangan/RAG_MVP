<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>RAG MVP - æ–‡ä»¶ä¸Šä¼ ä¸é—®ç­”</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .config-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .config-section h5 {
            color: #495057;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>RAG MVP - æ–‡ä»¶ä¸Šä¼ ä¸é—®ç­”</h1>
        <div>
            <a href="/chat" class="btn btn-primary me-2">
                <i class="fas fa-comments"></i> æ™ºèƒ½å¯¹è¯
            </a>
            <a href="/knowledge_base" class="btn btn-outline-primary me-2">
                <i class="fas fa-database"></i> çŸ¥è¯†åº“ç®¡ç†
            </a>
            <!-- æ–°å¢ï¼šç³»ç»Ÿè®¾ç½®å…¥å£ -->
            <a href="/config" class="btn btn-outline-secondary">
                <i class="fas fa-cog"></i> ç³»ç»Ÿè®¾ç½®
            </a>
        </div>
    </div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-warning">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}
    <form method="post" enctype="multipart/form-data">
        <!-- åŸºæœ¬é…ç½® -->
        <div class="config-section">
            <h5>ğŸ“„ åŸºæœ¬é…ç½®</h5>
            <div class="mb-3">
                <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶ï¼ˆtxt, docx, pdfï¼‰</label>
                <input class="form-control" type="file" id="file" name="file" required>
            </div>
            <div class="mb-3">
                <label for="question" class="form-label">è¯·è¾“å…¥ä½ çš„é—®é¢˜</label>
                <input class="form-control" type="text" id="question" name="question" placeholder="ä¾‹å¦‚ï¼šè¯·æ€»ç»“æ–‡æ¡£å†…å®¹" required>
            </div>
        </div>

        <!-- LLMé…ç½® -->
        <div class="config-section">
            <h5>ğŸ¤– LLMé…ç½®</h5>
            <div class="mb-3">
                <label for="llm_api_key" class="form-label">LLM API Key</label>
                <input class="form-control" type="text" id="llm_api_key" name="llm_api_key" placeholder="å¯é€‰ï¼Œç•™ç©ºåˆ™ç”¨é»˜è®¤é…ç½®">
            </div>
            <div class="mb-3">
                <label for="llm_model" class="form-label">LLMæ¨¡å‹å</label>
                <input class="form-control" type="text" id="llm_model" name="llm_model" placeholder="å¯é€‰ï¼Œç•™ç©ºåˆ™ç”¨é»˜è®¤é…ç½®">
            </div>
        </div>

        <!-- æ–‡æœ¬åˆ‡ç‰‡å‚æ•°è®¾ç½® -->
        <div class="config-section">
            <h5>âœ‚ï¸ æ–‡æœ¬åˆ‡ç‰‡é…ç½®</h5>
            <div class="form-group mt-3">
                <label for="split_method">æ–‡æœ¬åˆ‡ç‰‡æ–¹å¼ï¼š</label>
                <select class="form-control" id="split_method" name="split_method" onchange="onSplitMethodChange()">
                    <option value="paragraph">æŒ‰æ®µè½</option>
                    <option value="character">æŒ‰å­—ç¬¦æ•°</option>
                    <option value="sentence">æŒ‰å¥å­</option>
                </select>
            </div>
            <div id="character_params" style="display:none;">
                <div class="form-group mt-2">
                    <label for="chunk_size">æ¯å—æœ€å¤§å­—ç¬¦æ•°ï¼š</label>
                    <input type="number" class="form-control" id="chunk_size" name="chunk_size" value="800" min="100" max="2000">
                    <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š500-1000ï¼Œé»˜è®¤800ã€‚å¤ªå°å¯èƒ½ä¸¢å¤±ä¸Šä¸‹æ–‡ï¼Œå¤ªå¤§å¯èƒ½åŒ…å«æ— å…³ä¿¡æ¯ã€‚</small>
                </div>
                <div class="form-group mt-2">
                    <label for="chunk_overlap">ç›¸é‚»å—é‡å å­—ç¬¦æ•°ï¼š</label>
                    <input type="number" class="form-control" id="chunk_overlap" name="chunk_overlap" value="100" min="0" max="500">
                    <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š50-200ï¼Œé»˜è®¤100ã€‚é‡å å¤ªå°‘å¯èƒ½ä¸¢å¤±ä¿¡æ¯ï¼Œé‡å å¤ªå¤šä¼šå¢åŠ å†—ä½™ã€‚</small>
                </div>
            </div>
            <div id="sentence_params" style="display:none;">
                <div class="form-group mt-2">
                    <label for="max_sentences_per_chunk">æ¯å—æœ€å¤§å¥å­æ•°ï¼š</label>
                    <input type="number" class="form-control" id="max_sentences_per_chunk" name="max_sentences_per_chunk" value="3" min="1" max="10">
                    <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š2-5ï¼Œé»˜è®¤3ã€‚å¥å­æ•°å¤ªå°‘å¯èƒ½ä¿¡æ¯ä¸è¶³ï¼Œå¤ªå¤šå¯èƒ½åŒ…å«æ— å…³å†…å®¹ã€‚</small>
                </div>
            </div>
            <div id="paragraph_params" style="display:none;">
                <div class="form-group mt-2">
                    <label for="min_paragraph_length">æœ€å°æ®µè½é•¿åº¦ï¼ˆå­—ç¬¦ï¼‰ï¼š</label>
                    <input type="number" class="form-control" id="min_paragraph_length" name="min_paragraph_length" value="30" min="10" max="200">
                    <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š20-100ï¼Œé»˜è®¤30ã€‚å¤ªçŸ­å¯èƒ½ä¿¡æ¯ä¸è¶³ï¼Œå¤ªé•¿å¯èƒ½åŒ…å«æ— å…³å†…å®¹ã€‚</small>
                </div>
                <div class="form-group mt-2">
                    <label for="max_paragraph_length">æœ€å¤§æ®µè½é•¿åº¦ï¼ˆå­—ç¬¦ï¼‰ï¼š</label>
                    <input type="number" class="form-control" id="max_paragraph_length" name="max_paragraph_length" value="1500" min="200" max="3000">
                    <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š1000-2000ï¼Œé»˜è®¤1500ã€‚å¤ªé•¿å¯èƒ½åŒ…å«è¿‡å¤šæ— å…³ä¿¡æ¯ã€‚</small>
                </div>
            </div>
        </div>

        <!-- æ£€ç´¢å‚æ•°è®¾ç½® -->
        <div class="config-section">
            <h5>ğŸ” æ£€ç´¢é…ç½®</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="top_k">è¿”å›æœ€ç›¸å…³ç‰‡æ®µæ•° (top_k)ï¼š</label>
                        <input type="number" class="form-control" id="top_k" name="top_k" value="5" min="1" max="20">
                        <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š1-10ï¼Œé»˜è®¤5ã€‚æ•°å€¼è¶Šå¤§è¿”å›ç»“æœè¶Šå¤šï¼Œä½†å¯èƒ½åŒ…å«ä¸ç›¸å…³å†…å®¹ã€‚</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="similarity_threshold">ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š</label>
                        <input type="number" class="form-control" id="similarity_threshold" name="similarity_threshold" value="0.1" min="0.0" max="1.0" step="0.05">
                        <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š0.0-0.8ï¼Œé»˜è®¤0.1ã€‚æ•°å€¼è¶Šé«˜è¦æ±‚è¶Šä¸¥æ ¼ï¼Œå¯èƒ½è¿‡æ»¤æ‰ç›¸å…³å†…å®¹ã€‚</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="retrieval_strategy">æ£€ç´¢ç­–ç•¥ï¼š</label>
                        <select class="form-control" id="retrieval_strategy" name="retrieval_strategy">
                            <option value="cosine" selected>ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆæ¨èï¼‰</option>
                            <option value="dot_product">ç‚¹ç§¯ç›¸ä¼¼åº¦</option>
                            <option value="euclidean">æ¬§æ°è·ç¦»</option>
                        </select>
                        <small class="form-text text-muted">ä½™å¼¦ç›¸ä¼¼åº¦é€šå¸¸æ•ˆæœæœ€å¥½ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ã€‚</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="context_window">ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼š</label>
                        <input type="number" class="form-control" id="context_window" name="context_window" value="1" min="0" max="5">
                        <small class="form-text text-muted">æ¨èèŒƒå›´ï¼š0-3ï¼Œé»˜è®¤1ã€‚åŒ…å«ç›¸é‚»æ–‡æ¡£ç‰‡æ®µï¼Œå¢åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</small>
                    </div>
                </div>
            </div>
            <div class="form-group mt-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="deduplication" name="deduplication" value="true" checked>
                    <label class="form-check-label" for="deduplication">
                        å¯ç”¨å»é‡ç­–ç•¥
                    </label>
                    <small class="form-text text-muted d-block">å»é™¤é‡å¤æˆ–é«˜åº¦ç›¸ä¼¼çš„æ–‡æ¡£ç‰‡æ®µï¼Œæé«˜ç»“æœå¤šæ ·æ€§ã€‚</small>
                </div>
            </div>
        </div>

        <!-- æƒé‡é…ç½® -->
        <div class="config-section">
            <h5>âš–ï¸ æƒé‡é…ç½®</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="length_weight">æ–‡æ¡£é•¿åº¦æƒé‡ï¼š</label>
                        <select class="form-control" id="length_weight" name="length_weight">
                            <option value="" selected>æ— åå¥½ï¼ˆæ¨èï¼‰</option>
                            <option value="prefer_long">åå¥½é•¿æ–‡æ¡£</option>
                            <option value="prefer_short">åå¥½çŸ­æ–‡æ¡£</option>
                        </select>
                        <small class="form-text text-muted">é•¿æ–‡æ¡£é€šå¸¸åŒ…å«æ›´å¤šä¿¡æ¯ï¼ŒçŸ­æ–‡æ¡£æ›´ç®€æ´ã€‚æ ¹æ®éœ€æ±‚é€‰æ‹©ã€‚</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mt-2">
                        <label for="position_weight">æ–‡æ¡£ä½ç½®æƒé‡ï¼š</label>
                        <select class="form-control" id="position_weight" name="position_weight">
                            <option value="" selected>æ— åå¥½ï¼ˆæ¨èï¼‰</option>
                            <option value="prefer_early">åå¥½æ—©æœŸæ–‡æ¡£</option>
                            <option value="prefer_late">åå¥½åæœŸæ–‡æ¡£</option>
                        </select>
                        <small class="form-text text-muted">æ—©æœŸæ–‡æ¡£é€šå¸¸æ˜¯æ¦‚è¿°ï¼ŒåæœŸæ–‡æ¡£å¯èƒ½æ˜¯è¯¦ç»†è¯´æ˜ã€‚</small>
                    </div>
                </div>
            </div>
            <div class="form-group mt-2">
                <label for="keyword_weight">å…³é”®è¯æƒé‡ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼š</label>
                <input type="text" class="form-control" id="keyword_weight" name="keyword_weight" placeholder="ä¾‹å¦‚ï¼šé‡è¦,å…³é”®,æ ¸å¿ƒ,æ€»ç»“">
                <small class="form-text text-muted">åŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡æ¡£ç‰‡æ®µä¼šè·å¾—æ›´é«˜æƒé‡ã€‚å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™ä¸ä½¿ç”¨å…³é”®è¯æƒé‡ã€‚</small>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">ğŸš€ å¼€å§‹å¤„ç†</button>
    </form>
    <button id="pandaSyncBtn" class="btn btn-primary mt-3">åŒæ­¥ PandaWiki çŸ¥è¯†åº“</button>
    <div id="pandaSyncLog" style="white-space:pre;max-height:200px;overflow:auto;"></div>
    <div class="input-group mt-4">
      <input id="pandaQ" class="form-control" placeholder="å‘ PandaWiki çŸ¥è¯†åº“æé—®...">
      <button id="pandaAskBtn" class="btn btn-success">æ™ºèƒ½é—®ç­”</button>
    </div>
    <div id="pandaA" class="mt-2"></div>
    <script>
    $(function() {
        $('#pandaSyncBtn').click(function() {
            $('#pandaSyncLog').text('åŒæ­¥ä¸­...');
            $(this).prop('disabled', true).text('åŒæ­¥ä¸­...');
            $.post('/api/panda/sync', function(res) {
                if(res.success) {
                    $('#pandaSyncLog').text(res.logs.join('\n'));
                    alert('åŒæ­¥æˆåŠŸï¼');
                } else {
                    $('#pandaSyncLog').text('');
                    alert('åŒæ­¥å¤±è´¥: ' + (res.error || 'æœªçŸ¥é”™è¯¯'));
                }
                $('#pandaSyncBtn').prop('disabled', false).text('åŒæ­¥ PandaWiki çŸ¥è¯†åº“');
            });
        });
        $('#pandaAskBtn').click(function() {
            var q = $('#pandaQ').val();
            if(!q) return;
            $('#pandaA').text('æ€è€ƒä¸­...');
            // é»˜è®¤ç”¨ panda_sync ç›®å½•ä¸‹ç¬¬ä¸€ä¸ªçŸ¥è¯†åº“
            $.get('/api/panda/kb_list', function(kbs) {
                var kb_id = (kbs[0] && kbs[0].id) || 'default';
                $.ajax({
                    url: '/api/ai/answer',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({question: q, kb_id: kb_id}),
                    success: function(res) {
                        $('#pandaA').text(res.answer || 'æ— ç­”æ¡ˆ');
                    }
                });
            });
        });
    });
    </script>

    <script>
    function onSplitMethodChange() {
        var method = document.getElementById('split_method').value;
        document.getElementById('character_params').style.display = (method === 'character') ? '' : 'none';
        document.getElementById('sentence_params').style.display = (method === 'sentence') ? '' : 'none';
        document.getElementById('paragraph_params').style.display = (method === 'paragraph') ? '' : 'none';
    }
    document.addEventListener('DOMContentLoaded', onSplitMethodChange);
    </script>
</body>
</html>
